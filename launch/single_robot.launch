<launch>
    <arg name="gui" default="true" />
    <arg name="robot_x"   default="0.0" />
    <arg name="robot_y"   default="0.0" />
    <arg name="robot_yaw" default="0.0" />

    <arg name="tf_prefix" default="" doc="tf_prefix to be used by gazebo plugins and in the robot's urdf etc." />
    <arg name="prefix" value="$(arg tf_prefix)/" if="$(eval tf_prefix != '')" /> <!-- $(arg prefix) is used in all the config files! TODO: For multiple robots, create groups when loading the parameters to overwrite the arg? -->
    <arg name="prefix" value=""                  unless="$(eval tf_prefix != '')" />

    <arg name="model_name" default="mir" doc="Name of the Gazebo robot model (needs to be different for each robot)" />
    <arg name="namespace" default="$(arg tf_prefix)" doc="Namespace to push all topics into."/>
    <arg name="world_name" default="$(find sdl_gazebo)/world/lab_ar.world"/>

    <arg name="debug" default="false" />
    <arg name="load_robot_description" default="false"/>

    <arg name="map_rviz" default="true"/>
    <arg name="cam_rviz" default="true"/>

    <arg name="marker_size" default="10"/>

    <!-- Launch MIR files-->
    <include file="$(find sdl_application)/launch/load_world_mir.launch">
        <arg name="gui" value="$(arg gui)" />
        <arg name="robot_x"   value="$(arg robot_x)" />
        <arg name="robot_y"   value="$(arg robot_y)" />
        <arg name="robot_yaw" value="$(arg robot_yaw)" />
        <arg name="tf_prefix" value="$(arg tf_prefix)" />
        <arg name="namespace" value="$(arg namespace)" />
        <arg name="world_name" value="$(arg world_name)"/>
    </include>

    <!-- Load URDF -->
    <param name="robot_description" command="$(find xacro)/xacro --inorder '$(find sdl_application)/urdf/sdl_robot.urdf.xacro' prefix:=$(arg prefix)" />

    <!-- Spawn the robot into Gazebo -->
    <node name="spawn_urdf" pkg="gazebo_ros" type="spawn_model" args="-param robot_description -urdf -model $(arg model_name)
    -x $(arg robot_x) -y $(arg robot_y) -Y $(arg robot_yaw) " />

    <!-- Start controllers -->
    <include file="$(find sdl_application)/launch/ros_controllers.launch">
        <arg name="prefix" value="$(arg prefix)" />
    </include>

    <!-- Start MoveIt -->
    <include file="$(find sdl_moveit_config)/launch/move_group.launch"> 
        <arg name="allow_trajectory_execution" value="true"/>
        <arg name="fake_execution" value="false"/>
        <arg name="info" value="true"/>
        <arg name="debug" value="$(arg debug)"/>
        <arg name="load_robot_description" value="$(arg load_robot_description)"/>
    </include>

    <!-- Start the node to control the arm with MoveIt -->
    <node name="ur_python_planner" pkg="sdl_gazebo" type="sdl_moveit_node.py" output="screen" />
        
    <!-- MIR navigation -->
    <include file="$(find mir_navigation)/launch/hector_mapping.launch"/>
    <include file="$(find mir_navigation)/launch/move_base.xml">
        <arg name="with_virtual_walls" value="false"/>
    </include>

    <!-- Visualization of navigation and Kinect camera-->
    <group if="$(eval map_rviz)">
        <node type="rviz" name="map_rviz" pkg="rviz" args="-d $(find mir_navigation)/rviz/navigation.rviz" />
    </group>

    <group if="$(eval cam_rviz)">
        <node type="rviz" name="cam_rviz" pkg="rviz" args="-d $(find sdl_robot_description)/cfg/point_cloud_config.rviz" />
    </group>

    <!-- AR Tag detection -->
    <include file="$(find sdl_gazebo)/launch/ar_camera.launch">
        <arg name="marker_size" value="$(arg marker_size)" />
        <arg name="prefix" value="$(arg prefix)"/>
    </include>
    
</launch>